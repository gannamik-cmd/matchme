import os
import sys
import logging
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO,
    handlers=[
        logging.StreamHandler(sys.stdout),
        logging.FileHandler('bot.log')
    ]
)
logger = logging.getLogger(__name__)

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')

if not TOKEN:
    logger.error("‚ùå –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    logger.error("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_BOT_TOKEN")
    sys.exit(1)

def calculate_numerology(name: str) -> int:
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ —á–∏—Å–ª–æ –∏–º–µ–Ω–∏.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 9.
    """
    # –†—É—Å—Å–∫–∏–π –∞–ª—Ñ–∞–≤–∏—Ç —Å –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
    russian_alphabet = {
        '–∞': 1, '–±': 2, '–≤': 3, '–≥': 4, '–¥': 5, '–µ': 6, '—ë': 7, '–∂': 8, '–∑': 9,
        '–∏': 1, '–π': 2, '–∫': 3, '–ª': 4, '–º': 5, '–Ω': 6, '–æ': 7, '–ø': 8, '—Ä': 9,
        '—Å': 1, '—Ç': 2, '—É': 3, '—Ñ': 4, '—Ö': 5, '—Ü': 6, '—á': 7, '—à': 8, '—â': 9,
        '—ä': 1, '—ã': 2, '—å': 3, '—ç': 4, '—é': 5, '—è': 6
    }
    
    # –ê–Ω–≥–ª–∏–π—Å–∫–∏–π –∞–ª—Ñ–∞–≤–∏—Ç —Å –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
    english_alphabet = {
        'a': 1, 'b': 2, 'c': 3, 'd': 4, 'e': 5, 'f': 6, 'g': 7, 'h': 8, 'i': 9,
        'j': 1, 'k': 2, 'l': 3, 'm': 4, 'n': 5, 'o': 6, 'p': 7, 'q': 8, 'r': 9,
        's': 1, 't': 2, 'u': 3, 'v': 4, 'w': 5, 'x': 6, 'y': 7, 'z': 8
    }
    
    total = 0
    name_lower = name.lower()
    
    for char in name_lower:
        if char in russian_alphabet:
            total += russian_alphabet[char]
        elif char in english_alphabet:
            total += english_alphabet[char]
        # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –¥—Ä—É–≥–∏–µ —Å–∏–º–≤–æ–ª—ã
    
    # –ù—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ —Å–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –¥–æ –æ–¥–Ω–æ–π —Ü–∏—Ñ—Ä—ã
    while total > 9:
        total = sum(int(digit) for digit in str(total))
    
    return total if total > 0 else 1

def calculate_compatibility(name1: str, name2: str) -> dict:
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –¥–≤—É—Ö –∏–º–µ–Ω.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏.
    """
    num1 = calculate_numerology(name1)
    num2 = calculate_numerology(name2)
    
    # –û—Å–Ω–æ–≤–Ω–æ–π —Ä–∞—Å—á–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    compatibility_score = (num1 + num2) % 9
    if compatibility_score == 0:
        compatibility_score = 9
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
    love_score = (num1 * num2) % 10 + 1
    friendship_score = (abs(num1 - num2) + 1) % 10
    if friendship_score == 0:
        friendship_score = 1
    
    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    if compatibility_score >= 8:
        level = "–û—Ç–ª–∏—á–Ω–∞—è"
        emoji = "üíñ"
        description = "–í—ã –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç–µ –¥—Ä—É–≥ –¥—Ä—É–≥—É! –ì–∞—Ä–º–æ–Ω–∏—è –∏ –≤–∑–∞–∏–º–æ–ø–æ–Ω–∏–º–∞–Ω–∏–µ."
    elif compatibility_score >= 6:
        level = "–•–æ—Ä–æ—à–∞—è"
        emoji = "‚ú®"
        description = "–•–æ—Ä–æ—à–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–º –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è."
    elif compatibility_score >= 4:
        level = "–°—Ä–µ–¥–Ω—è—è"
        emoji = "ü§ù"
        description = "–°—Ç–∞–±–∏–ª—å–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —É–ª—É—á—à–µ–Ω–∏–π."
    else:
        level = "–ù–∏–∑–∫–∞—è"
        emoji = "üíî"
        description = "–ü–æ—Ç—Ä–µ–±—É—é—Ç—Å—è —É—Å–∏–ª–∏—è –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π."
    
    # –°–æ–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —á–∏—Å–µ–ª
    advice = {
        1: "–õ–∏–¥–µ—Ä—Å–∫–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞, —Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å —Ä–æ–ª–∏.",
        2: "–î–∏–ø–ª–æ–º–∞—Ç–∏—è –∏ –≥–∞—Ä–º–æ–Ω–∏—è - –≤–∞—à–∏ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã.",
        3: "–¢–≤–æ—Ä—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥ –ø–æ–º–æ–∂–µ—Ç –≤ —Ä–µ—à–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º.",
        4: "–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å - –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É.",
        5: "–ì–∏–±–∫–æ—Å—Ç—å –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–º–æ–≥—É—Ç –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.",
        6: "–ó–∞–±–æ—Ç–∞ –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å —É–∫—Ä–µ–ø—è—Ç —Å–≤—è–∑—å.",
        7: "–î—É—Ö–æ–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –≤–∞–∂–Ω—ã.",
        8: "–ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è.",
        9: "–ì—É–º–∞–Ω–∏–∑–º –∏ —Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç –≤–∞—Å."
    }
    
    return {
        'name1': name1,
        'name2': name2,
        'num1': num1,
        'num2': num2,
        'score': compatibility_score,
        'love_score': love_score,
        'friendship_score': friendship_score,
        'level': level,
        'emoji': emoji,
        'description': description,
        'advice': advice.get((num1 + num2) % 9 + 1, "–¶–µ–Ω–∏—Ç–µ –º–æ–º–µ–Ω—Ç—ã –≤–º–µ—Å—Ç–µ.")
    }

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user = update.effective_user
    
    welcome_text = (
        f"–ü—Ä–∏–≤–µ—Ç, {user.first_name}! üëã\n\n"
        "üîÆ *–Ø - –±–æ—Ç –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏*\n\n"
        "–Ø –º–æ–≥—É —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –¥–≤—É—Ö –∏–º–µ–Ω —Å –ø–æ–º–æ—â—å—é –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–∏.\n\n"
        "üìù *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*\n"
        "–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–≤–∞ –∏–º–µ–Ω–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª\n"
        "–ù–∞–ø—Ä–∏–º–µ—Ä: *–ê–Ω–Ω–∞ –ò–≤–∞–Ω*\n"
        "–ò–ª–∏: *John Mary*\n\n"
        "‚ú® *–ß—Ç–æ —è –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é:*\n"
        "‚Ä¢ –ß–∏—Å–ª–æ –∏–º–µ–Ω–∏ –∫–∞–∂–¥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞\n"
        "‚Ä¢ –û–±—â—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å\n"
        "‚Ä¢ –õ—é–±–æ–≤–Ω—É—é –∏ –¥—Ä—É–∂–µ—Å–∫—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å\n"
        "‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n\n"
        "‚ÑπÔ∏è *–í–∞–∂–Ω–æ:* –≠—Ç–æ —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å. "
        "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—á–µ—Ç–∞—Ö."
    )
    
    await update.message.reply_text(welcome_text, parse_mode='Markdown')

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = (
        "üìñ *–ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞*\n\n"
        "üí° *–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n"
        "/start - –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã\n"
        "/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
        "/about - –û –±–æ—Ç–µ\n\n"
        "üìù *–ö–∞–∫ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:*\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–≤–∞ –∏–º–µ–Ω–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª\n"
        "–ü—Ä–∏–º–µ—Ä—ã:\n"
        "‚Ä¢ `–ê–Ω–Ω–∞ –ò–≤–∞–Ω`\n"
        "‚Ä¢ `John Mary`\n"
        "‚Ä¢ `–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ú–∞—Ä–∏—è`\n\n"
        "‚ú® *–ß—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç —á–∏—Å–ª–∞:*\n"
        "1: –õ–∏–¥–µ—Ä—Å—Ç–≤–æ, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å\n"
        "2: –ì–∞—Ä–º–æ–Ω–∏—è, –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ\n"
        "3: –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ, –æ–±—â–µ–Ω–∏–µ\n"
        "4: –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –ø—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å\n"
        "5: –°–≤–æ–±–æ–¥–∞, –∏–∑–º–µ–Ω–µ–Ω–∏—è\n"
        "6: –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –∑–∞–±–æ—Ç–∞\n"
        "7: –ê–Ω–∞–ª–∏–∑, –¥—É—Ö–æ–≤–Ω–æ—Å—Ç—å\n"
        "8: –£—Å–ø–µ—Ö, –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ –±–ª–∞–≥–∞\n"
        "9: –ì—É–º–∞–Ω–∏–∑–º, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ\n\n"
        "üî¢ *–®–∫–∞–ª–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:*\n"
        "9-10: –ò–¥–µ–∞–ª—å–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å\n"
        "7-8: –û—Ç–ª–∏—á–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å\n"
        "5-6: –•–æ—Ä–æ—à–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å\n"
        "3-4: –°—Ä–µ–¥–Ω—è—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å\n"
        "1-2: –ù–∏–∑–∫–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å"
    )
    
    await update.message.reply_text(help_text, parse_mode='Markdown')

async def about_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /about"""
    about_text = (
        "‚ÑπÔ∏è *–û –±–æ—Ç–µ*\n\n"
        "ü§ñ *–ù—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –±–æ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏*\n"
        "–í–µ—Ä—Å–∏—è: 1.0\n\n"
        "üîÆ *–û—Å–Ω–æ–≤–∞ —Ä–∞—Å—á–µ—Ç–∞:*\n"
        "–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø—ã –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–∏ "
        "–¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏–º–µ–Ω.\n\n"
        "üìä *–ú–µ—Ç–æ–¥–∏–∫–∞:*\n"
        "1. –ö–∞–∂–¥–æ–π –±—É–∫–≤–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n"
        "2. –°—É–º–º–∞ –∑–Ω–∞—á–µ–Ω–∏–π –∏–º–µ–Ω–∏ —Å–≤–æ–¥–∏—Ç—Å—è –∫ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ–º—É —á–∏—Å–ª—É\n"
        "3. –ù–∞ –æ—Å–Ω–æ–≤–µ —á–∏—Å–µ–ª –∏–º–µ–Ω —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å\n\n"
        "üìö *–í–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å:*\n"
        "‚Ä¢ –≠—Ç–æ —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å\n"
        "‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–æ—Å—è—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä\n"
        "‚Ä¢ –ù–∞—Å—Ç–æ—è—â–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å—Ç—Ä–æ—è—Ç—Å—è –Ω–∞ –≤–∑–∞–∏–º–æ–ø–æ–Ω–∏–º–∞–Ω–∏–∏ –∏ —É–≤–∞–∂–µ–Ω–∏–∏\n\n"
        "üí´ –ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!"
    )
    
    await update.message.reply_text(about_text, parse_mode='Markdown')

def get_number_meaning(number: int) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —á–∏—Å–ª–∞"""
    meanings = {
        1: "–õ–∏–¥–µ—Ä, –Ω–æ–≤–∞—Ç–æ—Ä, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å",
        2: "–î–∏–ø–ª–æ–º–∞—Ç, –º–∏—Ä–æ–ª—é–±–∏–µ, –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ",
        3: "–¢–≤–æ—Ä–µ—Ü, –æ–ø—Ç–∏–º–∏–∑–º, —Å–∞–º–æ–≤—ã—Ä–∞–∂–µ–Ω–∏–µ",
        4: "–ü—Ä–∞–∫—Ç–∏–∫, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å",
        5: "–ê–≤–∞–Ω—Ç—é—Ä–∏—Å—Ç, —Å–≤–æ–±–æ–¥–∞, –∏–∑–º–µ–Ω–µ–Ω–∏—è",
        6: "–ó–∞–±–æ—Ç–ª–∏–≤—ã–π, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, —Å–µ–º—å—è",
        7: "–ê–Ω–∞–ª–∏—Ç–∏–∫, –º—É–¥—Ä–æ—Å—Ç—å, –¥—É—Ö–æ–≤–Ω–æ—Å—Ç—å",
        8: "–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä, —É—Å–ø–µ—Ö, –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ –±–ª–∞–≥–∞",
        9: "–ì—É–º–∞–Ω–∏—Å—Ç, —Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ"
    }
    return meanings.get(number, "–£–Ω–∏–∫–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è")

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    try:
        text = update.message.text.strip()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π
        if text.startswith('/'):
            return
        
        names = text.split()
        
        if len(names) >= 2:
            name1 = names[0]
            name2 = names[1]
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞, –æ–±—ä–µ–¥–∏–Ω—è–µ–º –∏—Ö
            if len(names) > 2:
                name1 = ' '.join(names[:2])
                name2 = ' '.join(names[2:4]) if len(names) >= 4 else names[2]
            
            logger.info(f"–†–∞—Å—á–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –¥–ª—è: {name1} –∏ {name2}")
            
            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
            result = calculate_compatibility(name1, name2)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
            response = (
                f"‚ú® *–ù—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏* ‚ú®\n\n"
                f"üë§ *{result['name1']}* ‚Üí –ß–∏—Å–ª–æ –∏–º–µ–Ω–∏: *{result['num1']}*\n"
                f"üë§ *{result['name2']}* ‚Üí –ß–∏—Å–ª–æ –∏–º–µ–Ω–∏: *{result['num2']}*\n\n"
                f"üìä *–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:*\n"
                f"‚Ä¢ –û–±—â–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: *{result['score']}/9* {result['emoji']}\n"
                f"‚Ä¢ –£—Ä–æ–≤–µ–Ω—å: *{result['level']}*\n"
                f"‚Ä¢ –õ—é–±–æ–≤–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: *{result['love_score']}/10* üíï\n"
                f"‚Ä¢ –î—Ä—É–∂–µ—Å–∫–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: *{result['friendship_score']}/10* ü§ù\n\n"
                f"üí≠ *–û–ø–∏—Å–∞–Ω–∏–µ:*\n"
                f"{result['description']}\n\n"
                f"üí° *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:*\n"
                f"{result['advice']}\n\n"
                f"üåô *–ß—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç –≤–∞—à–∏ —á–∏—Å–ª–∞:*\n"
                f"‚Ä¢ *{result['num1']}*: {get_number_meaning(result['num1'])}\n"
                f"‚Ä¢ *{result['num2']}*: {get_number_meaning(result['num2'])}\n\n"
                f"‚≠ê *–°–æ–≤–µ—Ç –æ—Ç –±–æ—Ç–∞:*\n"
                f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫–∞–∫ –ø–æ–≤–æ–¥ –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π, "
                f"–∞ –Ω–µ –∫–∞–∫ –∞–±—Å–æ–ª—é—Ç–Ω—É—é –∏—Å—Ç–∏–Ω—É. –ù–∞—Å—Ç–æ—è—â–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å—Ç—Ä–æ—è—Ç—Å—è "
                f"–Ω–∞ –≤–∑–∞–∏–º–æ–ø–æ–Ω–∏–º–∞–Ω–∏–∏, —É–≤–∞–∂–µ–Ω–∏–∏ –∏ –ª—é–±–≤–∏!"
            )
            
            await update.message.reply_text(response, parse_mode='Markdown')
            
        else:
            await update.message.reply_text(
                "üìù *–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–≤–∞ –∏–º–µ–Ω–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª.*\n\n"
                "–ü—Ä–∏–º–µ—Ä—ã:\n"
                "‚Ä¢ `–ê–Ω–Ω–∞ –ò–≤–∞–Ω`\n"
                "‚Ä¢ `John Mary`\n"
                "‚Ä¢ `–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ú–∞—Ä–∏—è`\n\n"
                "–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–µ –∏–º–µ–Ω–∞!",
                parse_mode='Markdown'
            )
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        await update.message.reply_text(
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã–µ –∏–º–µ–Ω–∞.",
            parse_mode='Markdown'
        )

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    logger.error(f"–û—à–∏–±–∫–∞: {context.error}")
    
    if update and update.effective_message:
        try:
            await update.effective_message.reply_text(
                "üòî –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –ø–æ–∑–∂–µ."
            )
        except:
            pass

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    logger.info("=" * 50)
    logger.info("üöÄ –ó–ê–ü–£–°–ö NUMEROLOGY COMPATIBILITY BOT")
    logger.info(f"–¢–æ–∫–µ–Ω: {'–ù–∞–π–¥–µ–Ω' if TOKEN else '–ù–µ –Ω–∞–π–¥–µ–Ω'}")
    logger.info("=" * 50)
    
    try:
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        app = Application.builder().token(TOKEN).build()
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
        app.add_handler(CommandHandler("start", start))
        app.add_handler(CommandHandler("help", help_command))
        app.add_handler(CommandHandler("about", about_command))
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
        app.add_error_handler(error_handler)
        
        logger.info("‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        logger.info("üîÑ –ó–∞–ø—É—Å–∫ polling...")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ - –ë–ï–ó –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ pool_timeout –∏ timeout!
        app.run_polling(
            drop_pending_updates=True,
            allowed_updates=Update.ALL_TYPES
        )
        
    except KeyboardInterrupt:
        logger.info("üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C)")
        sys.exit(0)
    except Exception as e:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: {e}")
        sys.exit(1)

if __name__ == '__main__':
    main()
